<script src="bower_components/braintree-web/client.js"></script>
<script src="bower_components/braintree-web/hosted-fields.js"></script>
<script src="bower_components/braintree-web/apple-pay.js"></script>
<script src="bower_components/braintree-web/paypal-checkout.js"></script>
<script src="bower_components/braintree-web/visa-checkout.js"></script>
<script src="bower_components/braintree-web/masterpass.js"></script>
<script src="bower_components/braintree-web/unionpay.js"></script>
<script src="bower_components/braintree-web/us-bank-account.js"></script>
<script src="bower_components/braintree-web/data-collector.js"></script>
<script src="bower_components/braintree-web/venmo.js"></script>
<script src="bower_components/jquery/dist/jquery.js"></script>



<script src="https://www.paypalobjects.com/api/checkout.js" data-version-4></script>
<script src="https://sandbox-assets.secure.checkout.visa.com/checkout-widget/resources/js/integration/v1/sdk.js"></script>

<div class="container-fluid">
  <div class="jumbotron">
    <h1>Braintree JS V.3</h1>
  </div>
</div>
  <div class="row">
    <div class="col-md-4"> </div>
    <div class="col-md-4">
      <label><input value="1" type="radio" name="formselector" onclick="displayForm(this)">Via Credit Card</label>
    </div>
    <div class="col-md-4"></div>
  </div>
  <div class="row">
    <div class="col-md-4"> </div>
    <div class="col-md-4">
      <label><input value="2" type="radio" name="formselector" onclick="displayForm(this)">Via Paypal</label>
    </div>
    <div class="col-md-4"></div>
  </div>
  <div class="row">
    <div class="col-md-4"> </div>
    <div  class="col-md-4">
      <label><input value="3" type="radio" name="formselector"  onclick="displayForm(this)">Via Visa Checkout</label>
    </div>
    <div class="col-md-4"></div>
  </div>
 </form>
 <div class="row">
   <div class="col-md-4"> </div>
   <div class="col-md-4">
     <label><input value="4" type="radio" name="formselector" onclick="displayForm(this)">Via MasterPass</label>
   </div>
   <div class="col-md-4"></div>
 </div>
 <div class="row" >
   <div class="col-md-4"> </div>
   <div class="col-md-4">
     <label id="venmo_radio_button" style="display:none"><input value="5" type="radio" name="formselector"  onclick="displayForm(this)">Via Venmo</label>
   </div>
   <div class="col-md-4"></div>
 </div>



<form id="credit_card_form"  method="post" action="/checkout" role="form">
  <input type="hidden" id="payment_method_nonce" name="payment_method_nonce" value="payment_method_nonce">
  <input type="hidden" id="device_data" name="device_data" value="device_data">

<div style="display:none" id="credit_card">
  <div class="row">
    <div class="col-md-4"> </div>
    <div class="col-md-4">
      <h1>Credit Card Form</h1>
    </div>
    <div class="col-md-4"></div>
  </div>
  <div class="row">
    <div class="col-md-4"> </div>
    <div class="col-md-4">
      <div class="credit-card" id="card-number"></div>
    </div>
    <div class="col-md-4"></div>
  </div>
  <div class="row">
    <div class="col-md-4"></div>
    <div class="col-md-2">
      <div class="expiration-date" id="expiration-date"></div>
    </div>
    <div class="col-md-2">
      <div class="cvv" id="cvv"></div>
    </div>
    <div class="col-md-4"></div>
  </div>
</div>

<div id="paypal_form" style="display:none" class="row">
  <div class="col-md-4"> </div>
  <div class="col-md-4">
     <div id="paypal-button"></div>
  </div>
  <div class="col-md-4"></div>
</div>

  <div id="visa_checkout_form" style="display:none" class="row">
    <div class="col-md-4"> </div>
    <div class="col-md-4">
      <div id="visa-checkout-button">
        <img alt="Visa Checkout" class="v-button" role="button"
        src="https://sandbox.secure.checkout.visa.com/wallet-services-web/xo/button.png?cardBrands=VISA,MASTERCARD,DISCOVER,AMEX"/>
        <script type="text/javascript"
          src="https://sandbox-assets.secure.checkout.visa.com/checkout-widget/resources/js/integration/v1/sdk.js">
        </script>
      </div>
    </div>
   <div class="col-md-4"></div>
   </div>

   <div id="masterpass_form" style="display:none" class="row">
     <div class="col-md-4"> </div>
     <div class="col-md-4">
       <div id="masterpass-button" class="button-hidden">
         <a href="#">
         <img alt="Checkout with Masterpass" role="button" src="https://static.masterpass.com/dyn/img/btn/global/mp_chk_btn_147x034px.svg" />
         </a>
      </div>
     </div>
    <div class="col-md-4"></div>
    </div>

    <div id="venmo_form" style="display:none" class="row">
      <div class="col-md-4"> </div>
      <div class="col-md-4">
        <div id="venmo-button" style ='display:none'>
          <a href="#">
          <img alt="Checkout with Venmo" role="button" src="/blue_venmo_button_280x48.svg" />
          </a>
       </div>
      </div>
     <div class="col-md-4"></div>
     </div>

   <div class="row">
     <div class="col-md-4"></div>
     <div class="col-md-4">
     <button type="button" id="checkout_button" style="display:none" class="btn btn-primary">Submit</button>
   </div>
     <div class="col-md-4"></div>
   </div>
</form>

<style>

.cvv {
  height: 36pt;
  width: 50pt;
  border: 2px ;
  background-color: #ffffff;
  border-radius: 5px;
  margin: 5px;
}
.credit-card {
  height: 36pt;
  width: 150pt;
  border: 2px ;
  background-color: #ffffff;
  border-radius: 5px;
  margin: 5px;
}
.expiration-date {
  height: 36pt;
  width: 75pt;
  border: 2px ;
  background-color: #ffffff;
  border-radius: 5px;
  margin: 5px;
}
</style>
<script>

var masterpassButton = document.getElementById('masterpass-button');
var submitButton = document.getElementById('checkout_button');
var creditCardForm = document.getElementById('credit_card_form');
var nonce = document.getElementById('payment_method_nonce');
var paypalButton = document.querySelector('#paypal-button');
var venmoButton = document.getElementById('venmo-button');
var venmoRadioButton = document.getElementById("venmo_radio_button");


braintree.client.create({
  authorization: "sandbox_54fcdrnq_yxb4zvxjdctbbppt"
}, function (err, client) {

  if (err) {
    console.error('Error creating client:', err);
    return;
  }

  braintree.hostedFields.create({
    client: client,
    styles: {
      'input': {
        'font-size': '14pt'
      },
      'input.invalid': {
        'color': 'red'
      },
      'input.valid': {
        'color': 'green'
      }
    },
    fields: {
      number: {
        selector: '#card-number',
        placeholder: '•••• •••• •••• ••••'
      },
      cvv: {
        selector: '#cvv',
        placeholder: "CVV"
      },
      expirationDate: {
        selector: '#expiration-date',
        placeholder: 'MM / YYYY'
      }
    }
  }, function (err, hostedFields) {

    if (err) {
      console.error('Error creating Hosted Fields:', err);
      return;
    }

    submitButton.removeAttribute('disabled');

    hostedFields.on('fieldEvent', function (event) {
      if (event.target.fieldKey !== 'number') { return; }

      if (event.card) {
        cvvLabel.innerHTML = event.card.code.name;
      } else {
        cvvLabel.innerHTML = 'CVV';
      }
    });


    submitButton.onclick = function() {

      event.preventDefault();

      hostedFields.tokenize(function (err, payload) {

        // Stop if there was an error.
        if (err) {
          if (err.type === 'CUSTOMER') {
            errorMessage.innerHTML = 'Your card info is invalid.';
          } else {
            console.error('Error tokenizing:', err);
          }
          return;
        }

        // Tokenization succeeded! Add the nonce to the form and submit.
      serverSubmit(payload);
      });
    }
  });

  braintree.paypalCheckout.create({
    client: client
    }, function (createErr, paypalCheckoutInstance) {
      if (createErr) {
        console.error('Error!', createErr);
        return;
      }

      paypal.Button.render({
        env: 'sandbox', // or 'sandbox'
        locale: 'en_US',

        payment: function () {
          return paypalCheckoutInstance.createPayment({
            flow: 'checkout',
            amount: '10.00',
            displayName: "Dan's Produce",
            currency: 'USD'
          });
        },

        onAuthorize: function (data, actions) {
          return paypalCheckoutInstance.tokenizePayment(data).then(function (payload) {
          serverSubmit(payload);

          });
        },

        onCancel: function (data) {
          console.log('checkout.js payment cancelled', JSON.stringify(data, 0, 2));
        },

        onError: function (err) {
          console.error('checkout.js error', err);
        }
      }, '#paypal-button'); // the PayPal button will be rendered in an html element with the id `paypal-button`
    });




    braintree.visaCheckout.create({
      client: client
      }, function (visaCheckoutErr, visaCheckoutInstance) {

      if (visaCheckoutErr) {
        document.getElementById("visa-checkout-button").style.display = 'none';
        console.error('Error creating VisaCheckout:', visaCheckoutErr);
        return;
      }

      visaCheckoutInitialized(visaCheckoutInstance);
      });

    braintree.masterpass.create({
     client: client
       }, function (masterpassErr, masterpassInstance) {
        if (masterpassErr) {
         console.error('Error creating Masterpass:', masterpassErr);
         return;
       }
       masterpassAvailable(masterpassInstance);
    });

    braintree.venmo.create({
     client: client,
  // Add allowNewBrowserTab: false if your checkout page does not support
  // relaunching in a new tab when returning from the Venmo app. This can
  // be omitted otherwise.
     allowNewBrowserTab: false
     }, function (venmoErr, venmoInstance) {
       if (venmoErr) {
         console.error('Error creating Venmo:', venmoErr);
         return;
         }

     // Verify browser support before proceeding.
     if (venmoInstance.isBrowserSupported()) {
        venmoRadioButton.style.display = "inline"
        displayVenmoButton(venmoInstance);
    return;
  }



  // Check if tokenization results already exist. This occurs when your
  // checkout page is relaunched in a new tab. This step can be omitted
  // if allowNewBrowserTab is false.
  if (venmoInstance.hasTokenizationResult()) {
    venmoInstance.tokenize(function (tokenizeErr, payload) {
      if (err) {
        handleVenmoError(tokenizeErr);
      } else {
        handleVenmoSuccess(payload);
      }
    });
    return;
  }
});



    braintree.dataCollector.create({
      client: client,
      kount: true,
      paypal: true
        }, function (err, dataCollectorInstance) {
         if (err) {
         // Handle error in creation of data collector
        return;
        }

        $('#device_data').val(dataCollectorInstance.deviceData);
    });
});

function displayVenmoButton(venmoInstance) {
  console.log("got to displayVenmoButton");
  // Assumes that venmoButton is initially display: none.
  venmoButton.style.display = 'inline-block';
  console.log("button should have new display properties");

  venmoButton.addEventListener('click', function () {
    venmoButton.disabled = true;

    venmoInstance.tokenize(function (tokenizeErr, payload) {
      venmoButton.removeAttribute('disabled');
      serverSubmit(payload);

    });
  });
}

function masterpassAvailable(masterpassInstance) {
  masterpassButton.classList.remove('button-hidden');
  var payment = {
   currencyCode: 'USD',
   subtotal: '10.00',
   // Optional configurations. See https://developer.mastercard.com/page/masterpass-lightbox-parameters for all options.
   config: {
     suppressShippingAddressEnable: true
   }
 }

 masterpassButton.addEventListener('click', function (event) {
   masterpassInstance.tokenize(payment, function (tokenizeErr, payload) {
     if (tokenizeErr) {
       if (tokenizeErr.code === 'MASTERPASS_POPUP_CLOSED') {
         console.log('Customer closed popup');
       } else {
         console.error('Error during Masterpass tokenization', tokenizeErr);
       }
       return;
     }
    serverSubmit(payload);
   });
 });
};



function visaCheckoutInitialized(visaCheckoutInstance) {
  var baseInitOptions = {
  paymentRequest: {
  currencyCode: "USD",
  subtotal: "10.00"
},
settings: {
  collectShipping: "true"
}
};

var initOptions = visaCheckoutInstance.createInitOptions(baseInitOptions);

V.init(initOptions);

V.on("payment.success", function (payment) {
   visaCheckoutInstance.tokenize(payment, function (tokenizeErr, payload) {
     if (tokenizeErr) {
       console.error('Error during Visa Checkout tokenization', tokenizeErr);
     } else {
     // Send payload.nonce to your server, and create a transaction there.
     serverSubmit(payload);
    }
 });
});
}



function serverSubmit(payload) {
  $('#payment_method_nonce').val(payload.nonce);
  console.log(JSON.stringify(payload));
  alert(JSON.stringify(payload));
  document.getElementById("credit_card_form").submit();
}

function displayForm(c) {
       if (c.value == "1") {
           document.getElementById("credit_card").style.display = 'inline';
           document.getElementById("checkout_button").style.display = 'inline';
           document.getElementById("paypal_form").style.display = 'none';
           document.getElementById("visa_checkout_form").style.display = 'none';
           document.getElementById("masterpass_form").style.display = 'none';
           document.getElementById("venmo_form").style.display = 'none';
       } else if (c.value == "2") {
           document.getElementById("credit_card").style.display = 'none';
           document.getElementById("checkout_button").style.display = 'none';
           document.getElementById("paypal_form").style.display = 'inline';
           document.getElementById("visa_checkout_form").style.display = 'none';
           document.getElementById("masterpass_form").style.display = 'none';
           document.getElementById("venmo_form").style.display = 'none';
       } else if (c.value == "3") {
           document.getElementById("credit_card").style.display = 'none';
           document.getElementById("checkout_button").style.display = 'none';
           document.getElementById("paypal_form").style.display = 'none';
           document.getElementById("visa_checkout_form").style.display = 'inline';
           document.getElementById("masterpass_form").style.display = 'none';
           document.getElementById("venmo_form").style.display = 'none';
       } else if (c.value == "4") {
           document.getElementById("credit_card").style.display = 'none';
           document.getElementById("checkout_button").style.display = 'none';
           document.getElementById("paypal_form").style.display = 'none';
           document.getElementById("visa_checkout_form").style.display = 'none';
           document.getElementById("masterpass_form").style.display = 'inline';
           document.getElementById("venmo_form").style.display = 'none';
        } else if (c.value == "5") {
            document.getElementById("credit_card").style.display = 'none';
            document.getElementById("checkout_button").style.display = 'none';
            document.getElementById("paypal_form").style.display = 'none';
            document.getElementById("visa_checkout_form").style.display = 'none';
            document.getElementById("masterpass_form").style.display = 'none';
            document.getElementById("venmo_form").style.display = 'inline';
         } else {}
      }


</script>
